# WARNING - Generated by {fusen} from dev/flat_build_envs.Rmd: do not edit by hand

testthat::test_that("find_rev returns correct nixpkgs hash", {
  testthat::expect_equal(
              find_rev("4.2.2"),
              "8ad5e8132c5dcf977e308e7bf5517cc6cc0bf7d8"
            )

  testthat::expect_equal(
              find_rev("8ad5e8132c5dcf977e308e7bf5517cc6cc0bf7d8"),
              "8ad5e8132c5dcf977e308e7bf5517cc6cc0bf7d8"
            )
})

testthat::test_that("available_r lists all available r versions", {
  testthat::expect_equal(
              available_r(),
              c("latest", "3.0.2",  "3.0.3",  "3.1.0",  "3.1.2",  "3.1.3",  "3.2.0",  "3.2.1",
                "3.2.2",  "3.2.3",  "3.2.4",  "3.3.3",  "3.4.0",  "3.4.1",  "3.4.2",  "3.4.3",
                "3.4.4",  "3.5.0",  "3.5.1",  "3.5.2",  "3.5.3",  "3.6.0",  "3.6.1",  "3.6.2",
                "3.6.3",  "4.0.0",  "4.0.2",  "4.0.3",  "4.0.4",  "4.1.1",  "4.1.2",  "4.1.3",
                "4.2.0",  "4.2.1",  "4.2.2",  "4.2.3",  "4.3.1"
                )
            )
})



testthat::test_that("get_sri_hash_deps returns correct sri hash and dependencies of R packages", {
  testthat::expect_equal(
              get_sri_hash_deps("https://github.com/rap4all/housing/",
                                "fusen",
                                "1c860959310b80e67c41f7bbdc3e84cef00df18e"),
              list(
                "sri_hash" = "sha256-s4KGtfKQ7hL0sfDhGb4BpBpspfefBN6hf+XlslqyEn4=",
                "deps" = "dplyr ggplot2 janitor purrr readxl rlang rvest stringr tidyr"
              )
            )
})


testthat::test_that("Snapshot test of rix()", {


  save_default_nix_test <- function(ide) {

    path_default_nix <- tempdir()

    rix(r_ver = "4.3.1",
        r_pkgs = c("dplyr", "janitor", "AER@1.2-8", "quarto"),
        system_pkgs = c("quarto"),
        tex_pkgs = c("amsmath"),
        git_pkgs = list(
          list(package_name = "housing",
               repo_url = "https://github.com/rap4all/housing/",
               branch_name = "fusen",
               commit = "1c860959310b80e67c41f7bbdc3e84cef00df18e"),
          list(package_name = "fusen",
               repo_url = "https://github.com/ThinkR-open/fusen",
               branch_name = "main",
               commit = "d617172447d2947efb20ad6a4463742b8a5d79dc")
        ),
        ide = ide,
        project_path = path_default_nix,
        overwrite = TRUE)

    paste0(path_default_nix, "/default.nix")

  }

  testthat::announce_snapshot_file("find_rev/rstudio_default.nix")

  testthat::expect_snapshot_file(
              path = save_default_nix_test(ide = "rstudio"),
              name = "rstudio_default.nix",
              )

  testthat::announce_snapshot_file("find_rev/other_default.nix")

  testthat::expect_snapshot_file(
              path = save_default_nix_test(ide = "other"),
              name = "other_default.nix"
            )

  testthat::announce_snapshot_file("find_rev/code_default.nix")

  testthat::expect_snapshot_file(
              path = save_default_nix_test(ide = "code"),
              name = "code_default.nix"
              )

})


testthat::test_that("Snapshot test of rix_init()", {

  skip_on_covr()

  save_rix_init_test <- function() {

    path_env_nix <- tempdir()

    rix_init(
      project_path = path_env_nix,
      rprofile_action = "overwrite",
      message_type = "simple"
    )

    paste0(path_env_nix, "/.Rprofile")

  }

  testthat::announce_snapshot_file("find_rev/golden_Rprofile.txt")

  testthat::expect_snapshot_file(
              path = save_rix_init_test(),
              name = "golden_Rprofile.txt",
              )
})

testthat::test_that("Testing with_nix() if Nix is installed", {

  skip_if_not(nix_shell_available())

  skip_on_covr()

  path_env_stringr <- file.path(".", "_env_stringr_1.4.1")

  rix_init(
    project_path = path_env_stringr,
    rprofile_action = "overwrite",
    message_type = "simple"
  )

  rix(
    r_ver = "latest",
    r_pkgs = "stringr@1.4.1",
    overwrite = TRUE,
    project_path = path_env_stringr
  )

  out_nix_stringr <- with_nix(
    expr = function() stringr::str_subset(c("", "a"), ""),
    program = "R",
    exec_mode = "non-blocking",
    project_path = path_env_stringr,
    message_type = "simple"
  )

  # on a recent version of stringr, stringr::str_subset(c("", "a"), "")
  # should result in an error, but older versions would return "a"
  # to avoid having a dependency on stringr just for this test,
  # we see if the old version still returns "a"
  testthat::expect_true(
              identical("a", out_nix_stringr)
            )

  on.exit(unlink(path_env_stringr, recursive = TRUE, force = TRUE))

})

