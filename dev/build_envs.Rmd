---
title: "Build envs"
output: html_document
editor_options:
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

<!--
You need to run the 'description' chunk in the '0-dev_history.Rmd' file before continuing your code there.
-->

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```

This function takes an R version as an input and returns the Nix revision that provides it:

```{r function-find_rev}
#' find_rev Find the right Nix revision
#' @param r_version Character. R version to look for, for example, "4.2.0"
#' @return A character. The Nix revision to use
#' @export
#'
#' @examples
#' find_rev("4.2.0")
find_rev <- function(r_version){

  if(r_version == "current"){
    return(get_current())
  } else {

  temp <- new.env(parent = emptyenv())

  data(list = "r_nix_revs",
       package = "rix",
       envir = temp)

  get("r_nix_revs", envir = temp)

  output <- r_nix_revs$revision[r_nix_revs$version == r_version]

  stopifnot("Error: the provided R version is likely wrong. Please check that you provided a correct R version. You can list available versions using `available_r()`" = !identical(character(0), output))

    output
}

}

```

```{r tests-find_rev}
testthat::expect_equal(
            find_rev("4.2.2"),
            "8ad5e8132c5dcf977e308e7bf5517cc6cc0bf7d8"
          )
```

This function return available R versions:

```{r function-available_r}
#' available_r List available R versions
#' @return A character vector containing the available R versrions.
#' @export
#'
#' @examples
#' available_r()
available_r <- function(){

  temp <- new.env(parent = emptyenv())

  data(list = "r_nix_revs",
       package = "rix",
       envir = temp)

  get("r_nix_revs", envir = temp)

  c("current", r_nix_revs$version)

}

```

The function below will return the very latest commit from the unstable branch
of `NixOS/nixpkgs`. This will make sure that users that want to use the most
up-to-date version of R and R packages can do so:

```{r function-get_current}
#' get_current Get the current R version and packages
#' @return A character. The commit hash of the latest nixpkgs-unstable revision
#' @importFrom httr content GET stop_for_status
#' @importFrom jsonlite fromJSON
#' @export
#'
#' @examples
get_current <- function() {
  api_url <- "https://api.github.com/repos/NixOS/nixpkgs/commits?sha=nixpkgs-unstable"

  tryCatch({
    response <- httr::GET(url = api_url)
    httr::stop_for_status(response)
    commit_data <- jsonlite::fromJSON(httr::content(response, "text"))
    latest_commit <- commit_data$sha[1]
    return(latest_commit)
  }, error = function(e) {
    cat("Error:", e$message, "\n")
    return(NULL)
  })
}
```

This function formats a `DESCRIPTION`'s file `imports` to return them
for the `propagatedBuildInputs` of a Nix `buildRPackage()` statement:

```{r function-get_imports}
get_imports <- function(repo_url, rev){

  add_trailing_slash <- function(repo_url) {
    if (substr(repo_url, nchar(repo_url), nchar(repo_url)) != "/") {
      repo_url <- paste0(repo_url, "/")
    }
    repo_url
  }

  remove_parentheses <- function(input_list) {
    output_list <- gsub("\\s*\\(.*?\\)", "", input_list)
    output_list
  }

  repo_url <- add_trailing_slash(repo_url)

  repo_url <- paste0(
    gsub("github.com", "raw.githubusercontent.com", repo_url),
    rev,
    "/DESCRIPTION"
  )

  contents <- readLines(repo_url)

  contents <- remove_parentheses(contents)

  imports_line <- grep("^Imports:", contents)


  input_string <- paste(trimws(contents[(imports_line+1):length(contents)]),
                        collapse = " ")


  output <- regmatches(input_string,
                       regexpr(".*?(?<!,)\\s", input_string, perl = TRUE))

  gsub(",", "", trimws(output))

}

```

```{r, tests-get_imports}

testthat::expect_equal(
            get_imports("https://github.com/tidyverse/dplyr",
                        "1832ffbbdf3a85145b1545b84ee7b55a99fbae98"),
            "cli generics glue lifecycle magrittr methods pillar R6 rlang tibble tidyselect utils vctrs"
          )

testthat::expect_equal(
            get_imports("https://github.com/rap4all/housing/",
                        "1c860959310b80e67c41f7bbdc3e84cef00df18e"),
            "dplyr ggplot2 janitor purrr readxl rlang rvest stringr tidyr utils"
          )


```


```{r function-get_hash}
library(openssl)

get_sri_hash <- function(tarball_path) {
  if (!file.exists(tarball_path)) {
    stop("The specified tarball file does not exist.")
  }

  # does the same thing as nix hash file --sri filepath,
  # but doesn't work on a directory as it must be "nar"ed first
  # Read the content of the tarball file
  tarball_content <- readBin(tarball_path, "raw", n = file.info(tarball_path)$size)

  # Calculate the SHA256 hash
  sha256_hash <- openssl::sha256(tarball_content)

  # Convert the raw SHA256 hash to Base64
  base64_hash <- base64enc::base64encode(sha256_hash)

  # "SRI hashes" notation requires the "sha256-" prefix
  paste0("sha256-", base64_hash)
}
```

Function `fetchgit()` takes a git repository as an input and returns a
string using the Nix `fetchgit()` function to install the package. It
automatically finds the right `sha256` as well:

```{r function-make_fetchgit}
fetchgit <- function(name, url, branchName, rev){

  imports <- get_imports(url, rev)

  instructions <- '(buildRPackage {
    name = "housing";
    src = fetchgit {
      url = "https://github.com/rap4all/housing/";
      branchName = "fusen";
      rev = "1c860959310b80e67c41f7bbdc3e84cef00df18e";
      sha256 = "sha256-s4KGtfKQ7hL0sfDhGb4BpBpspfefBN6hf+XlslqyEn4=";
    };
    propagatedBuildInputs = [
      PUT_IMPORTS_HERE
      ];
  })'

}

```

This next function returns a `default.nix` file that can be used to build a
reproducible environment. This function takes an R version as an input (the
correct Nix revision is found using `find_rev()`), a list of R packages, and
whether the user wants to work with RStudio or not in that environment. If
you use another IDE, you can leave the "ide" argument blank:

```{r function-rix}
#' rix Build a reproducible development environment definition
#' @return Nothing, this function only has the side-effect of writing a file
#'   called "default.nix" in the working directory. This file contains the
#'   instructions to build a reproducible environment using the Nix package
#'   manager.
#' @param r_ver Character, defaults to "current". The required R version. To use the current version
#'   of R, use "current". You can check which R versions are available using `available_r`.
#' @param r_pkgs Vector of characters. List the required R packages for your
#'   analysis here.
#' @param other_pkgs Vector of characters. List further software you wish to install that
#'   are not R packages.
#' @param ide Character, defaults to "other". If you wish to use RStudio to work
#'   interactively use "rstudio", "code" for Visual Studio Code. For other editors,
#'   use "other". This has been tested with RStudio, VS Code and Emacs. If other
#'   editors don't work, please open an issue.
#' @param path Character, defaults to the current working directory. Where to write 
#'   `default.nix`, for example "/home/path/to/project".
#'   The file will thus be written to "/home/path/to/project/default.nix".     
#' @param overwrite Logical, defaults to FALSE. If TRUE, overwrite the `default.nix`
#'   file in the specified path.
#' @details This function will write a `default.nix` in the chosen path. Using
#'   the Nix package manager, it is then possible to build a reproducible
#'   development environment using the `nix-build` command in the path. This
#'   environment will contain the chosen version of R and packages, and will not
#'   interfere with any other installed version (via Nix or not) on your
#'   machine. Every dependency, including both R package dependencies but also
#'   system dependencies like compilers will get installed as well in that
#'   environment. If you use RStudio for interactive work, then set the
#'   `rstudio` parameter to `TRUE`. If you use another IDE (for example Emacs or
#'   Visual Studio Code), you do not need to add it to the `default.nix` file,
#'   you can simply use the version that is installed on your computer. To use
#'   Visual Studio Code however, you need to install the `{languageserver}`
#'   package, so don't forget to add it to the list of packages. Once you built
#'   the environment using `nix-build`, you can drop into an interactive session
#'   using `nix-shell`. See the "How-to Nix" vignette for more details.
#' @export
rix <- function(r_ver = "current",
                r_pkgs,
                other_pkgs = NULL,
                ide = "other",
                path = ".",
                overwrite = FALSE){

  stopifnot("'ide' has to be one of 'other', 'rstudio' or 'code'" = (ide %in% c("other", "rstudio", "code")))

  path <- if(path == "."){
     "default.nix"
  } else {
    paste0(path, "/default.nix")
  }

  path <- file.path(path)

  pkgs <- if(ide == "code"){
            c(r_pkgs, "languageserver")
          } else {
            r_pkgs
          }

  r_packages <- paste(r_pkgs, collapse = ' ')
  other_packages <- paste(other_pkgs, collapse = ' ')

  nixTemplate <- "
# This file was generated by the {rix} R package on DATE
# It uses nixpkgs' revision RE_VERSION for reproducibility purposes
# Report any issues to https://github.com/b-rodrigues/rix
    { pkgs ? import (fetchTarball \"https://github.com/NixOS/nixpkgs/archive/RE_VERSION.tar.gz\") {} }:

      with pkgs;

      let
      my-r = rWrapper.override {
        packages = with rPackages; [PACKAGE_LIST];
      };
OTHER_PACKAGES other-pkgs = [OTHER_PKGS];
USE_RSTUDIO  my-rstudio = rstudioWrapper.override {
USE_RSTUDIO    packages = with rPackages; [PACKAGE_LIST];
USE_RSTUDIO};
      in
      mkShell {
        buildInputs = [
          my-r
         USE_RSTUDIO my-rstudio
         OTHER_PACKAGES other-pkgs
          ];
      }"

  nixFile <- gsub('RE_VERSION', find_rev(r_ver) , nixTemplate)
  r_packages <- gsub('\\.', '_', r_packages)
  nixFile <- gsub('PACKAGE_LIST', r_packages, nixFile)
  nixFile <- gsub('OTHER_PKGS', other_packages, nixFile)
  nixFile <- gsub('OTHER_PACKAGES', ifelse(!is.null(other_pkgs), '', '#'), nixFile)
  nixFile <- gsub('DATE', date(), nixFile)
  nixFile <- gsub('USE_RSTUDIO', ifelse(!is.null(ide) & ide == "rstudio", '', '#'), nixFile)

  if(!file.exists(path) | overwrite){
    writeLines(nixFile, path)
  } else {
    stop(paste0("File exists at ", path, ". Set `overwrite == TRUE` to overwrite."))
  }

}

```
